{% extends "base.html" %}

{% block page_content %}

<div class="panel">
    <div class="title">
        <h1>Your Dashboard</h1>
        <div id="result">
            <div id="below-avg" style="display: none">
                Good boy
            </div>
            <div id="above-avg" style="display: none">
                <p>Oh it looks like your CO<sub>2</sub> footprint is above average this week.</p>
                <button onclick="toCompensate()" type="submit">Let's compensate it!</button>
            </div>
        </div>
        <div class="diagram">
            <div id="chartdiv" style="width: 100%; height: 400px;">
                <h2>Loading data...</h2>
            </div>
        </div>
    </div>
</div>

<script src="../static/js/core.js"></script>
<script src="../static/js/charts.js"></script>
<script src="../static/js/material.js"></script>
<script>
    am4core.useTheme(am4themes_material);

    var chart = am4core.create("chartdiv", am4charts.XYChart);

    data = {
        "data": [{
            "date": 31,
            "gwp": 4561,
            "avg": 4232
        }, {
            "date": 32,
            "gwp": 5687,
            "avg": 4928
        }, {
            "date": 33,
            "gwp": 6348,
            "avg": 6432
        }, {
            "date": 34,
            "gwp": 4878,
            "avg": 4922
        }, {
            "date": 35,
            "gwp": 6867,
            "avg": 4992
        }, {
            "date": 36,
            "gwp": 7561,
            "avg": 4642
        }, {
            "date": 37,
            "gwp": 4287,
            "avg": 3873
        }]
    };

    data.data.map(ele => ele.date = getDateOfWeek(ele.date, 2018));
    chart.data = data.data;

    chart.dateFormatter.inputDateFormat = "YYYY-MM-dd";
    chart.zoomOutButton.disabled = true;

    var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
    dateAxis.renderer.grid.template.strokeOpacity = 0;
    dateAxis.renderer.minGridDistance = 10;
    dateAxis.dateFormats.setKey("day", "d");
    dateAxis.tooltip.hiddenState.properties.opacity = 1;
    dateAxis.tooltip.hiddenState.properties.visible = true;

    var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
    valueAxis.renderer.inside = true;
    valueAxis.renderer.labels.template.fillOpacity = 0.3;
    valueAxis.renderer.grid.template.strokeOpacity = 0;
    valueAxis.min = 0;
    valueAxis.cursorTooltipEnabled = false;

    var axisRange = valueAxis.axisRanges.create();
    axisRange.value = 6000;
    axisRange.grid.strokeOpacity = 0.1;
    axisRange.label.align = "right";
    axisRange.label.verticalCenter = "bottom";
    axisRange.label.fillOpacity = 0.8;

    valueAxis.renderer.gridContainer.zIndex = 1;

    var axisRange2 = valueAxis.axisRanges.create();
    axisRange2.value = 10000;
    axisRange2.grid.strokeOpacity = 0.1;
    axisRange2.label.align = "right";
    axisRange2.label.verticalCenter = "bottom";
    axisRange2.label.fillOpacity = 0.8;

    var series = chart.series.push(new am4charts.ColumnSeries);
    series.dataFields.valueY = "gwp";
    series.dataFields.dateX = "date";
    series.tooltipText = "Your GWP: {valueY} KG CO2";
    series.tooltip.hiddenState.properties.opacity = 1;
    series.tooltip.hiddenState.properties.visible = true;

    var avg = chart.series.push(new am4charts.LineSeries());
    avg.name = "Average";
    avg.dataFields.dateX = "date";
    avg.dataFields.valueY = "avg";
    avg.tooltipText = "Average GWP: {valueY.value} KG CO2";
    avg.fill = am4core.color("#2c3dc1");
    avg.stroke = am4core.color("#2c3dc1");
    avg.strokeWidth = 3;

    var columnTemplate = series.columns.template;
    columnTemplate.width = 30;
    columnTemplate.column.cornerRadiusTopLeft = 3;
    columnTemplate.column.cornerRadiusTopRight = 3;
    columnTemplate.strokeOpacity = 0;

    chart.scrollbarX = new am4core.Scrollbar();

    columnTemplate.adapter.add("fill", function (fill, target) {
        var dataItem = target.dataItem;
        if (dataItem.valueY > dataItem.dataContext.avg) {
            return am4core.color("#b72411");
        } else {
            return am4core.color("#39a526");
        }
    })

    var cursor = new am4charts.XYCursor();
    cursor.behavior = "panX";
    chart.cursor = cursor;
    cursor.lineX.disabled = true;

    function toUpload() {
        window.location = '/upload';
    }

    function toCompensate() {
        window.location = '/compensate';
    }

    function getDateOfWeek(w, y) {
        var d = (1 + (w - 1) * 7);
        return new Date(y, 0, d).toISOString().substring(0, 10);
    }

    $(function () {
        let newest = data.data.reduce(function (a, b) {
            return a.date > b.date ? a : b
        });
        if (newest.gwp > newest.avg) {
            let usagePercentage = newest.gwp / newest.avg * 100 - 100;
            localStorage.setItem('usagePercentage', usagePercentage.toFixed(2));
            $("#above-avg").css("display", "block")
        } else {
            $("#below-avg").css("display", "block")
        }
    });
</script>

{% endblock %}